<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Creación de destinos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  {% load static %}
  <script src="{% static 'clearFds.js' %}"></script>
</head>

<body>

  <div class="container mt-5">
    <h1>Crear Destino</h1>
    <div class="row">

      <form method="post" class="row g-3" id="destino_form" name="form">
        {% csrf_token %}

        <div class="col-md-5">
          <label class="form-label">Nombre del destinos:</label>
          <input type="text" class="form-control" placeholder="Nombre destino" id="name" name="name" required>
        </div>

        <div class="col-md-9">
          <input type="submit" value="Crear destino" class="btn btn-primary">
        </div>
      </form>
      {% if messages %}
      {% for message in messages %}
      <script>
        if (window.opener) {
          window.onload = function () {
            alert('{{ message }}');

            // Obtener el valor de la ventana padre
            var ventanaPadre = window.opener.document.getElementById("wf").value;
            console.log(ventanaPadre)

            // Obtener Id después del mensaje
            var mensaje = "{{ message }}";
            var destination = mensaje.split(": ")[1];

            // Lógica para determinar la ventana padre y actuar en consecuencia
            if (ventanaPadre === 'salida') {
              // Obtener los valores de los elementos necesarios de la ventana padre
              var name = window.opener.document.getElementById("name").value;
              var code = window.opener.document.getElementById("code").value;
              var cas = window.opener.document.getElementById("cas").value;
              var reference_id = window.opener.document.getElementById("reference").value;
              var is_liquid = window.opener.document.getElementById("is_liquid").value;
              var weight = window.opener.document.getElementById("weight").value;
              var unit = window.opener.document.getElementById("unit").value;
              var location = window.opener.document.getElementById("location").value;
              var marca_id = window.opener.document.getElementById("trademark").value;
              var manager = window.opener.document.getElementById("manager").value;
              var stock = window.opener.document.getElementById("stock").value;
              var observations = window.opener.document.getElementById("observations").value;

              // Recargar la página padre
              window.opener.location.replace(window.opener.location.href);

              // Retardo para que los valores se escriban después de recargar la página
              setTimeout(function () {
                // Acceder a la ventana padre y actualizar los valores
                window.opener.document.querySelector("#name").value = name;
                window.opener.document.querySelector("#code").value = code;
                window.opener.document.querySelector("#cas").value = cas;
                window.opener.document.querySelector("#is_liquid").value = is_liquid;
                window.opener.document.querySelector("#weight").value = weight;
                window.opener.document.querySelector("#unit").value = unit;
                window.opener.document.querySelector("#location").value = location;
                window.opener.document.querySelector("#manager").value = manager;
                window.opener.document.querySelector("#stock").value = stock;
                window.opener.document.querySelector("#observations").innerHTML = observations;

                // Actualiza Select reference
                var referencia_new = window.opener.document.querySelector("#reference");
                referencia_new.value = reference_id;
                referencia_new.setAttribute("selected", true);

                // Actualiza Select destination
                var destination_new = window.opener.document.querySelector("#destination");
                destination_new.value = destination;
                destination_new.setAttribute("selected", true);

                // Actualiza Select trademark
                var marca_new = window.opener.document.querySelector("#trademark");
                marca_new.value = marca_id;
                marca_new.setAttribute("selected", true);

                window.close();
              }, 500);
            }
            else if (ventanaPadre === 'entrada') {
              // Obtener los valores de los elementos necesarios de la ventana padre
              var name = window.opener.document.getElementById("name").value;
              var code = window.opener.document.getElementById("code").value;
              var cas = window.opener.document.getElementById("cas").value;
              var edate = window.opener.document.getElementById("edate").value;
              var reference = window.opener.document.getElementById("reference").value;
              var is_liquid = window.opener.document.getElementById("is_liquid").value;
              var weight = window.opener.document.getElementById("weight").value;
              var order = window.opener.document.getElementById("order").value;
              var unit = window.opener.document.getElementById("unit").value;
              var price = window.opener.document.getElementById("price").value;
              var location = window.opener.document.getElementById("location").value;
              var nproject = window.opener.document.getElementById("nproject").value;
              var marca_id = window.opener.document.getElementById("trademark").value;
              var manager = window.opener.document.getElementById("manager").value;
              var observations = window.opener.document.getElementById("observations").value;

              // Recargar la página padre
              window.opener.location.replace(window.opener.location.href);

              // Retardo para que los valores se escriban después de recargar la página
              setTimeout(function () {
                // Acceder a la ventana padre y actualizar los valores
                window.opener.document.querySelector("#name").value = name;
                window.opener.document.querySelector("#code").value = code;
                window.opener.document.querySelector("#cas").value = cas;
                window.opener.document.querySelector("#edate").value = edate;
                window.opener.document.querySelector("#reference").value = reference;
                window.opener.document.querySelector("#is_liquid").value = is_liquid;
                window.opener.document.querySelector("#weight").value = weight;
                window.opener.document.querySelector("#unit").value = unit;
                window.opener.document.querySelector("#price").value = price;
                window.opener.document.querySelector("#location").value = location;
                window.opener.document.querySelector("#nproject").value = nproject;
                window.opener.document.querySelector("#manager").value = manager;
                window.opener.document.querySelector("#observations").innerHTML = observations;
                window.opener.document.querySelector("#order").value = order;

                // Actualiza Select destination
                var destination_new = window.opener.document.querySelector("#destination");
                destination_new.value = destination;
                destination_new.setAttribute("selected", true);

                // Actualiza Select trademark
                var marca_new = window.opener.document.querySelector("#trademark");
                marca_new.value = marca_id;
                marca_new.setAttribute("selected", true);

                window.close();
              }, 500);
            }
          };
        }

        else {
          window.onload = function () {

            alert('{{ message }}');

          };
        }

      </script>


      {% endfor %}
      {% endif %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"></script>
</body>

</html>