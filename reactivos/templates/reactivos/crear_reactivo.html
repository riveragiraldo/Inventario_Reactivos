<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Registro de reactivos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    {% load static %}
    <script src="{% static 'codeconst.js' %}" defer></script>
    <script src="{% static 'clearFds.js' %}"></script>

</head>

<body>



    <h1>Crear reactivo</h1>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8">

                <form method="post" class="row g-3" id="form" name="form">
                    {% csrf_token %}

                    <div class="col-md-2">
                        <label class="form-label">Color (o SGA):</label>
                        <input type="number" class="form-control" placeholder="Núm. Color (o SGA)" id="color"
                            name="color" required min="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Número:</label>
                        <input type="number" class="form-control" placeholder="Núm. reactivo" id="number" name="number"
                            required min="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Sub - Número:</label>
                        <input type="text" class="form-control" placeholder="Sub-Número reactivo" id="subnumber"
                            name="subnumber" pattern="[A-Z0-9]*|[1-9][0-9]*"
                            title="Ingrese números positivos o letras mayúsculas">

                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Código interno:</label>
                        <input type="text" class="form-control" name="code" id="code" placeholder="Código interno"
                            title="Código interno" readonly>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Código CAS:</label>
                        <input type="text" step="any" class="form-control" placeholder="Código CAS" name="cas" required
                            id="cas">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Nombre del reactivo:</label>
                        <input type="text" class="form-control" placeholder="Nombre de reactivo" name="name" required
                            id="name">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Presentación:</label>
                        <select name="state" class="form-select" required id="selectState">

                            {% for estado in estados %}
                            <option value="{{ estado.id }}">{{ estado.name }}</option>
                            {% endfor %}

                        </select>

                    </div>

                    <div class="col-md-1">
                        <label class="form-label" style="color: transparent;">Add</label>
                        <button type="button" id="add_state_btn" class="btn btn-secondary"
                            title="Agregar Presentación">+</button>
                    </div>
                    <script>
                        function openPopupWindow() {
                            var w = 450; // ancho de la ventana emergente
                            var h = 400; // altura de la ventana emergente
                            var left = (screen.width / 2) - (w / 2);
                            var top = (screen.height / 2) - (h / 2);
                            window.open("{% url 'reactivos:crear_estado' %}", "popup", "width=" + w + ",height=" + h + ",left=" + left + ",top=" + top);
                        }
                        var addUnitBtn = document.getElementById("add_state_btn");
                        addUnitBtn.addEventListener("click", openPopupWindow);
                    </script>

                    <div class="col-md-2">
                        <label class="form-label">Unidades:</label>
                        <select name="unit" class="form-select" required id="selectUnidades">
                            {% for unidad in unidades %}
                            <option value="{{ unidad.id }}">{{ unidad.name }}</option>
                            {% endfor %}
                        </select>

                    </div>


                    <div class="col-md-1">
                        <label class="form-label" style="color: transparent;">Add</label>
                        <button type="button" id="add_unit_btn" class="btn btn-secondary"
                            title="Agregar Unidad">+</button>
                    </div>
                    <script>
                        function openPopupWindow() {
                            var w = 450; // ancho de la ventana emergente
                            var h = 400; // altura de la ventana emergente
                            var left = (screen.width / 2) - (w / 2);
                            var top = (screen.height / 2) - (h / 2);
                            window.open("{% url 'reactivos:crear_unidades' %}", "popup", "width=" + w + ",height=" + h + ",left=" + left + ",top=" + top);
                        }
                        var addUnitBtn = document.getElementById("add_unit_btn");
                        addUnitBtn.addEventListener("click", openPopupWindow);
                    </script>

                    <script>
                        // Función para verificar si la ventana actual es una ventana emergente
                        function isPopupWindow() {
                            return window.opener != null;
                        }

                        // Función para ocultar los botones de agregar si es una ventana emergente
                        function hideAddButtonsIfPopup() {
                            var addStateBtn = document.getElementById("add_state_btn");
                            var addUnitBtn = document.getElementById("add_unit_btn");

                            if (isPopupWindow()) {
                                addStateBtn.style.display = "none";
                                addUnitBtn.style.display = "none";
                            }
                        }

                        // Ejecutar la función al cargar la página
                        hideAddButtonsIfPopup();
                    </script>

                    <div class="col-md-3">
                        <label class="form-label">Ubicación en Almacén:</label>
                        <input type="text" class="form-control" placeholder="Ubicación" name="wlocation"
                            id="warehouselocation">
                    </div>

                    <div class="col-md-3 mt-3">
                        <input type="button" value="Crear Reactivo" class="btn btn-primary" id="open_confirm_rcreate">
                    </div>
                    <div class="col-md-3 mt-3">
                        <input type="reset" value="Limpiar Campos" class="btn btn-primary">
                    </div>

                </form>
                {% if messages %}
                {% for message in messages %}
                <script>
                    if (window.opener) {

                        window.onload = function () {

                            alert('{{ message }}');

                            //Obtener nombre despues del mensaje
                            mensaje = "{{ message }}";
                            var name = mensaje.split(": ")[1];


                            //retardo para que los valores se escriban despues de recargar la página
                            setTimeout(function () {
                                window.opener.document.querySelector("#name").value = name;
                                if (window.opener && typeof window.opener.updateFields === "function") {
                                    window.opener.updateFields();
                                } else {
                                    console.error("La función updateFields() no está definida en la ventana padre");
                                }

                                window.close();

                            }, 500);




                        };
                    }

                    else {
                        window.onload = function () {

                            alert('{{ message }}');

                        };
                    }


                </script>
                {% endfor %}
                {% endif %}
                <script>


                    function validarCampos() {
                        var campos = document.querySelectorAll("form input[required], form select[required], form textarea[required]");
                        for (var i = 0; i < campos.length; i++) {
                            if (!campos[i].value) {
                                alert("Por favor, complete todos los campos obligatorios.");
                                return false;
                            }
                        }
                        return true;
                    }

                    function openPopupWindowConfirm() {
                        if (validarCampos()) {
                            var formData = obtenerDatosFormulario();
                            var mensaje = "Los datos registrados son:\n\n" + formData;

                            if (confirm(mensaje)) {
                                var csrfToken = obtenerCSRFToken();  // Obtener el valor del token CSRF
                                var formData = obtenerDatosFormularioenviar();
                                enviarInformacion(formData, csrfToken);
                            }
                        }
                    }

                    function enviarInformacion(formData, csrfToken) {
                        fetch('', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken
                            },
                            body: formData
                        })
                            .then(response => {
                                if (response.ok) {
                                    // La solicitud se realizó con éxito
                                    console.log('Datos enviados correctamente');
                                    //window.location.reload();



                                }
                                else {
                                    // La solicitud falló
                                    console.error('Error al enviar los datos');
                                }

                            })

                            .then(data => {
                                // Se recibió una respuesta exitosa, procesar los datos y mostrar mensajes
                                console.log('Respuesta del servidor:', data);
                                // Realiza cualquier acción adicional que desees después de recibir los datos

                                // Recargar la página después de 500 ms
                                setTimeout(() => {


                                    window.location.reload();




                                }, 500);


                            })



                            .catch(error => {
                                // Ocurrió un error al realizar la solicitud
                                console.error('Error de red:', error);
                            });
                    }

                    function obtenerDatosFormulario() {
                        var campos = document.querySelectorAll("form input, form select, form textarea");
                        var formData = "";

                        for (var i = 0; i < campos.length; i++) {
                            var campo = campos[i];
                            var etiquetaAsociada = obtenerEtiquetaAsociada(campo);
                            var valorCampo = obtenerValorCampo(campo);

                            // Filtrar botones y token CSRF
                            if (campo.tagName.toLowerCase() === 'button' || campo.tagName.toLowerCase() === 'input' && (campo.type === 'button' || campo.type === 'reset') || campo.name === 'csrfmiddlewaretoken') {
                                continue;
                            }


                            formData += etiquetaAsociada + " " + valorCampo + "\n";
                        }

                        return formData;
                    }

                    function obtenerDatosFormularioenviar() {
                        var campos = document.querySelectorAll("form input, form select, form textarea");
                        var formData = new FormData();

                        for (var i = 0; i < campos.length; i++) {
                            var nombreCampo = campos[i].name;
                            var valorCampo = campos[i].value;
                            formData.append(nombreCampo, valorCampo);
                        }

                        return formData;
                    }

                    function obtenerEtiquetaAsociada(campo) {
                        var etiqueta = campo.previousElementSibling;
                        if (etiqueta) {
                            return etiqueta.textContent.trim();
                        }

                        return campo.name;
                    }

                    function obtenerValorCampo(campo) {
                        if (campo.tagName.toLowerCase() === "select") {
                            var opcionSeleccionada = campo.options[campo.selectedIndex];
                            return opcionSeleccionada.textContent;
                        }

                        return campo.value;
                    }

                    function obtenerCSRFToken() {
                        var csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
                        if (csrfInput) {
                            return csrfInput.value;
                        }
                        return null;
                    }



                    var addUnitBtn = document.getElementById("open_confirm_rcreate");
                    addUnitBtn.addEventListener("click", openPopupWindowConfirm);




                </script>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
            crossorigin="anonymous"></script>

</body>

</html>